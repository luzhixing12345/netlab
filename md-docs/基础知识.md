
# 基础知识

## OSI 和 TCP/IP 模型

网络通信也是一个非常庞大的系统工程,网络协议势必也需要采用分层设计思想.为此,国际标准化组织提出了开放式系统互联模型( open system interconnection model ),简称 OSI模型 .

OSI模型是一种概念模型,用于指导通信系统设计,并实现标准化.该模型将通信系统中的数据流划分为七个层. 但是目前使用最广泛的通信协议是 TCP/IP 系列协议. TCP/IP模型中的层次结构相对较简单,减少了设计和实现的复杂性

![20240101115001](https://raw.githubusercontent.com/learner-lu/picbed/master/20240101115001.png)

## UDP 和 TCP

TCP/IP协议栈中,TCP和UDP属于传输层,负责实现数据的传输.

其中TCP是面向连接的和基于单个字节流的/保证顺序的可靠传输协议,UDP是无连接的/不可靠的/面向报文的协议.两者的报文格式如下所示

![20231231165858](https://raw.githubusercontent.com/learner-lu/picbed/master/20231231165858.png)

最后的数据报在网络层添加上 IP 头部信息之后封装成数据包, 通过路由从源主机传输到目标主机

![20231231171018](https://raw.githubusercontent.com/learner-lu/picbed/master/20231231171018.png)

其中 UDP 只有 8 字节的报文头部, 也只记录了源端口目的端口, 当数据包从网卡发送出去之后**可能损坏, 可能丢包, 可能乱序**, 发送方只负责将这个数据包发送出去, 只是一种 "**尽力而为**" 的策略, 至于接收方如何, 是否收到, 是否还有能力(缓冲区)接收, 是否乱序都不是 UDP 协议负责的内容;

TCP 的报文虽然也可能出现上述损坏丢包乱序这些问题, 但在数据包头部额外添加了 "序号" 和 "确认号" 用于**确认数据包到达**, 一些数据位(例如 SYN ACK FIN)用于**确认通信双方状态**, **窗口大小用于流量控制**, 因此在传输层实现了**可靠传输**;

## TCP

TCP 协议与包括 UDP 在内的其他传输层协议的主要差别在于:数据传输质量 .UDP 协议将数据发送出去之后就不管了,但 TCP 还会对已发送的数据进行跟踪,以防丢失.这样就有效地实现了 TCP 协议的两个关键特性:

- 可靠性( reliability ),保证数据可靠送到目的地(如有丢失,必须能够检测出来,并重传);
- 流量控制( flow control ),控制数据发送速度,以免冲垮接收方;

为实现这两个设计目标,TCP 协议引入了所谓的 **滑动窗口**( sliding window )机制, 除此之外 TCP 还有流量控制和拥塞控制的手段

流量控制(Flow Control):

- 定义: 流量控制是指在发送方和接收方之间协调数据传输速率的一种机制,**以确保接收方能够处理接收到的数据而不会溢出或丢失**.
- 位置: 通常发生在通信的端到端(end-to-end)之间,即在通信的两端设备之间.
- 目的: 防止接收方被过多的数据淹没,确保接收方能够按照自己的速度来接收和处理数据.

拥塞控制(Congestion Control):

- 定义: 拥塞控制是指在整个网络中协调数据传输速率的一种机制,**以防止网络拥塞并提高网络的性能**.
- 位置: 通常发生在网络的中间部分,涉及到多个设备和路由器之间的通信.
- 目的: 防止网络中的某些部分过载,避免数据包的丢失/延迟增加和整体性能下降.

## TCP 的确认机制

由于 IP 协议缺乏反馈机制,为保证可靠性,TCP 协议规定:当接收方收到一个数据后,必须回复 ACK 给发送方.这样发送方就能得到反馈,如果数据发出去后很长时间都没有收到 ACK 确认,说明数据很有可能已经丢失了.

一旦数据在传输过程中丢失,发送方必须重传.因此,TCP 每次发送数据后,都会启动一个定时器.如果定时器超时还没收到对方确认,TCP 就会重新发送数据.由于 IP 协议缺乏反馈机制,为保证可靠性,TCP 协议规定:当接收方收到一个数据后,必须回复 ACK 给发送方.这样发送方就能得到反馈,如果数据发出去后很长时间都没有收到 ACK 确认,说明数据很有可能已经丢失了.

1. 累积确认(Cumulative Acknowledgment):

   TCP使用累积确认机制,表示接收方已成功收到并按序处理了截至确认序号的所有字节.如果接收方成功收到序号为X的数据,那么它将发送一个确认序号为X+1的确认消息,表示它已经准备好接收从X+1开始的数据.

2. 选择确认(Selective Acknowledgment):

   选择确认是TCP的一种扩展机制,允许接收方在确认中明确指定已成功接收的数据块范围,而不仅仅是最后一个累积确认的序号.这提高了对丢失或重复数据的处理能力.

3. **延迟确认**(Delayed Acknowledgment):

   延迟确认是指接收方不立即发送确认,而是等待一段时间,看是否有更多的数据需要一起确认.这可以减少确认消息的数量,提高网络利用率.

4. 紧急确认(Urgent Acknowledgment):

   紧急确认用于处理TCP紧急数据.如果接收方收到带有紧急标志的TCP数据,它会立即回复一个紧急确认,通知发送方已经成功接收了紧急数据.

   > SSH ctrl+C 启用紧急指针, 中断正在进行的操作, 优先处理, 快速响应

## TCP 的流量控制

接收缓冲区大小是有限的,如果应用进程处理缓慢,发送方还拼命发送,最终肯定会压垮接收方.因此,当缓冲区有变化时,接收方应该通过 **窗口大小** 字段,将它的剩余大小告知发送方.

接收方通告的窗口大小通常称为 通告窗口( advertised window ),可缩写为 awnd .它起到约束发送方发送速度的作用:

- 如果接收方应用进程繁忙,迟迟未读取缓冲区里的数据,那么窗口大小将慢慢变小;
- 当窗口大小降为零,发送方就停止发送新数据;

通过通告窗口,**发送方可以实时感知接收方缓冲区的状态**,然后根据缓冲区剩余空间动态调整发送速度,这就是 TCP 的 流量控制( flow control )机制.

## TCP 滑动窗口

![20240101195349](https://raw.githubusercontent.com/learner-lu/picbed/master/20240101195349.png)

## TCP 拥塞控制

我们希望 TCP 能够根据网络链路的实时状态,自动调整发送速度,这就是 TCP 协议的 拥塞控制( congestion control )机制.拥塞控制机制细节很复杂,但原理却出奇的简单:

- 维护拥塞窗口,限制数据发送量;
- 根据网络当前状态,实时调节拥塞窗口:
  - 如果长时间未收到 ACK 而发生数据重传,说明网络可能拥塞,缩小拥塞窗口,降低发送速度;
  - 每收到一个有效 ACK 都增大拥塞窗口,提高发送速度,因为这通常意味着网络状态良好;

方法:

- 慢启动
- 拥塞避免
- 快速重传
- 快速恢复

## 参考

- [fasionchan sliding-window](https://fasionchan.com/network/tcp/sliding-window/)
- [fasionchan congestion-control](https://fasionchan.com/network/tcp/congestion-control/)